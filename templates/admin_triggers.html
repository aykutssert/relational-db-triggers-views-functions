<!-- templates/admin_triggers.html -->
{% extends "base.html" %}
{% block title %}Database Triggers{% endblock %}
{% block content %}
<h1>Database Triggers - System Logs</h1>

<div class="card" style="background: #e8f5e8; margin-bottom: 20px;">
    <h3>ğŸ”¥ 5 FarklÄ± Database Trigger</h3>
    <p>Trigger'lar otomatik olarak Ã§alÄ±ÅŸÄ±r ve tÃ¼m iÅŸlemler system_logs tablosuna kaydedilir. AÅŸaÄŸÄ±da trigger'larÄ±n Ã§alÄ±ÅŸma kayÄ±tlarÄ±nÄ± gÃ¶rebilirsiniz.</p>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('book-logs')">ğŸ“š Kitap LoglarÄ±</div>
    <div class="tab" onclick="showTab('user-logs')">ğŸ‘¥ KullanÄ±cÄ± LoglarÄ±</div>
    <div class="tab" onclick="showTab('stock-logs')">ğŸ“¦ Stok LoglarÄ±</div>
    <div class="tab" onclick="showTab('order-logs')">ğŸ’° SipariÅŸ LoglarÄ±</div>
    <div class="tab" onclick="showTab('all-logs')">ğŸ“„ TÃ¼m Loglar</div>
</div>

<div id="book-logs" class="tab-content active">
    <h2>Trigger 1 & 2: Kitap Ekleme/GÃ¼ncelleme LoglarÄ±</h2>
    <div class="card" style="background: #f8f9fa; margin-bottom: 15px;">
        <p><strong>Trigger'lar:</strong> book_insert_log (AFTER INSERT) & book_update_log (AFTER UPDATE)</p>
    </div>
    
    {% if triggers_data.book_logs %}
    <table class="table">
        <thead>
            <tr>
                <th>Log ID</th>
                <th>Ä°ÅŸlem</th>
                <th>Kitap ID</th>
                <th>Eski DeÄŸerler</th>
                <th>Yeni DeÄŸerler</th>
                <th>Zaman</th>
            </tr>
        </thead>
        <tbody>
            {% for log in triggers_data.book_logs %}
            <tr>
                <td><strong>{{ log.log_id }}</strong></td>
                <td>
                    {% if log.operation == 'INSERT' %}
                        <span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">â• {{ log.operation }}</span>
                    {% else %}
                        <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">âœï¸ {{ log.operation }}</span>
                    {% endif %}
                </td>
                <td><strong>{{ log.record_id }}</strong></td>
                <td style="max-width: 200px; word-wrap: break-word;">{{ log.old_values or '-' }}</td>
                <td style="max-width: 200px; word-wrap: break-word;">{{ log.new_values }}</td>
                <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="card" style="background: #e3f2fd; text-align: center; padding: 30px;">
        <h4>ğŸ“š HenÃ¼z kitap iÅŸlem logu yok</h4>
        <p>Kitap ekleyerek veya stok gÃ¼ncelleyerek trigger'Ä± test edebilirsiniz.</p>
        <a href="{{ url_for('admin_books') }}" class="btn">Kitap Ekle/GÃ¼ncelle</a>
    </div>
    {% endif %}
</div>

<div id="user-logs" class="tab-content">
    <h2>Trigger 5: KullanÄ±cÄ± Ekleme LoglarÄ±</h2>
    <div class="card" style="background: #f8f9fa; margin-bottom: 15px;">
        <p><strong>Trigger:</strong> user_insert_log (AFTER INSERT ON users)</p>
    </div>
    
    {% if triggers_data.user_logs %}
    <table class="table">
        <thead>
            <tr>
                <th>Log ID</th>
                <th>Ä°ÅŸlem</th>
                <th>KullanÄ±cÄ± ID</th>
                <th>KullanÄ±cÄ± Bilgileri</th>
                <th>Zaman</th>
            </tr>
        </thead>
        <tbody>
            {% for log in triggers_data.user_logs %}
            <tr>
                <td><strong>{{ log.log_id }}</strong></td>
                <td><span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ğŸ‘¤ {{ log.operation }}</span></td>
                <td><strong>{{ log.record_id }}</strong></td>
                <td>{{ log.new_values }}</td>
                <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="card" style="background: #e3f2fd; text-align: center; padding: 30px;">
        <h4>ğŸ‘¥ HenÃ¼z kullanÄ±cÄ± ekleme logu yok</h4>
        <p>Yeni kullanÄ±cÄ± ekleyerek trigger'Ä± test edebilirsiniz.</p>
        <a href="{{ url_for('admin_users') }}" class="btn">KullanÄ±cÄ± Ekle</a>
    </div>
    {% endif %}
</div>

<div id="stock-logs" class="tab-content">
    <h2>Trigger 3: Stok GÃ¼ncelleme LoglarÄ±</h2>
    <div class="card" style="background: #f8f9fa; margin-bottom: 15px;">
        <p><strong>Trigger:</strong> order_stock_update (AFTER INSERT ON order_details)</p>
    </div>
    
    {% if triggers_data.stock_logs %}
    <table class="table">
        <thead>
            <tr>
                <th>Log ID</th>
                <th>Ä°ÅŸlem</th>
                <th>Kitap ID</th>
                <th>Stok DÃ¼ÅŸÃ¼rme DetaylarÄ±</th>
                <th>Zaman</th>
            </tr>
        </thead>
        <tbody>
            {% for log in triggers_data.stock_logs %}
            <tr>
                <td><strong>{{ log.log_id }}</strong></td>
                <td><span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ğŸ“¦ STOCK_UPDATE</span></td>
                <td><strong>{{ log.record_id }}</strong></td>
                <td>{{ log.new_values }}</td>
                <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="card" style="background: #e3f2fd; text-align: center; padding: 30px;">
        <h4>ğŸ“¦ HenÃ¼z stok gÃ¼ncelleme logu yok</h4>
        <p>MÃ¼ÅŸteri panelinden sipariÅŸ vererek trigger'Ä± test edebilirsiniz.</p>
        <a href="{{ url_for('customer_dashboard') }}" class="btn">SipariÅŸ Ver</a>
    </div>
    {% endif %}
</div>

<div id="order-logs" class="tab-content">
    <h2>Trigger 4: SipariÅŸ Toplam Hesaplama LoglarÄ±</h2>
    <div class="card" style="background: #f8f9fa; margin-bottom: 15px;">
        <p><strong>Trigger:</strong> order_total_calculation (AFTER INSERT ON order_details)</p>
    </div>
    
    {% if triggers_data.order_logs %}
    <table class="table">
        <thead>
            <tr>
                <th>Log ID</th>
                <th>Ä°ÅŸlem</th>
                <th>KayÄ±t ID</th>
                <th>Ä°ÅŸlem DetaylarÄ±</th>
                <th>Zaman</th>
            </tr>
        </thead>
        <tbody>
            {% for log in triggers_data.order_logs %}
            <tr>
                <td><strong>{{ log.log_id }}</strong></td>
                <td><span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ğŸ’° {{ log.operation }}</span></td>
                <td><strong>{{ log.record_id }}</strong></td>
                <td>{{ log.new_values }}</td>
                <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="card" style="background: #e3f2fd; text-align: center; padding: 30px;">
        <h4>ğŸ’° HenÃ¼z sipariÅŸ iÅŸlem logu yok</h4>
        <p>SipariÅŸ vererek toplam hesaplama trigger'Ä±nÄ± test edebilirsiniz.</p>
        <a href="{{ url_for('customer_dashboard') }}" class="btn">SipariÅŸ Ver</a>
    </div>
    {% endif %}
</div>

<div id="all-logs" class="tab-content">
    <h2>TÃ¼m System LoglarÄ± (Son 50 KayÄ±t)</h2>
    <div class="card" style="background: #f8f9fa; margin-bottom: 15px;">
        <p><strong>TÃ¼m Trigger Ä°ÅŸlemleri:</strong> Kronolojik sÄ±rayla tÃ¼m trigger kayÄ±tlarÄ±</p>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Log ID</th>
                <th>Tablo</th>
                <th>Ä°ÅŸlem</th>
                <th>KayÄ±t ID</th>
                <th>Detaylar</th>
                <th>Zaman</th>
            </tr>
        </thead>
        <tbody>
            {% for log in triggers_data.book_logs + triggers_data.user_logs + triggers_data.stock_logs + triggers_data.order_logs %}
            <tr>
                <td><strong>{{ log.log_id }}</strong></td>
                <td>
                    {% if log.table_name == 'books' %}
                        <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">ğŸ“š books</span>
                    {% elif log.table_name == 'users' %}
                        <span style="background: #fff3e0; padding: 2px 6px; border-radius: 4px;">ğŸ‘¤ users</span>
                    {% else %}
                        <span style="background: #e8f5e8; padding: 2px 6px; border-radius: 4px;">ğŸ“¦ order_details</span>
                    {% endif %}
                </td>
                <td>{{ log.operation }}</td>
                <td><strong>{{ log.record_id }}</strong></td>
                <td style="max-width: 300px; word-wrap: break-word;">{{ log.new_values }}</td>
                <td>{{ log.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="background: #fff3e0; margin-top: 30px;">
    <h4>ğŸ¯ Trigger Test Rehberi</h4>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
        <div>
            <h5>âœ… Trigger'larÄ± NasÄ±l Test Ederim?</h5>
            <ol style="padding-left: 20px;">
                <li><strong>Kitap Trigger:</strong> Kitaplar sekmesinden yeni kitap ekleyin</li>
                <li><strong>Stok Trigger:</strong> Kitap stokunu gÃ¼ncelleyin</li>
                <li><strong>KullanÄ±cÄ± Trigger:</strong> KullanÄ±cÄ±lar sekmesinden yeni kullanÄ±cÄ± ekleyin</li>
                <li><strong>SipariÅŸ Trigger:</strong> MÃ¼ÅŸteri panelinden sipariÅŸ verin</li>
            </ol>
        </div>
        <div>
            <h5>ğŸ“Š Trigger DetaylarÄ±:</h5>
            <ul style="padding-left: 20px;">
                <li><strong>AFTER INSERT/UPDATE:</strong> Ä°ÅŸlem sonrasÄ± Ã§alÄ±ÅŸÄ±r</li>
                <li><strong>FOR EACH ROW:</strong> Her satÄ±r iÃ§in ayrÄ± Ã§alÄ±ÅŸÄ±r</li>
                <li><strong>OLD/NEW:</strong> Eski ve yeni deÄŸerleri tutar</li>
                <li><strong>Otomatik Log:</strong> TÃ¼m iÅŸlemler kaydedilir</li>
            </ul>
        </div>
    </div>
</div>

<div class="card" style="background: #e8f5e8;">
    <h4>ğŸ’¡ CanlÄ± Test Ã–nerisi</h4>
    <p>Trigger'larÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in:</p>
    <ol style="padding-left: 20px; margin: 10px 0;">
        <li>Bu sayfayÄ± aÃ§Ä±k tutun</li>
        <li>BaÅŸka bir sekmede admin panelinden iÅŸlem yapÄ±n (kitap ekle, stok gÃ¼ncelle, kullanÄ±cÄ± ekle)</li>
        <li>Bu sayfayÄ± yenileyin (F5)</li>
        <li>Yeni trigger kayÄ±tlarÄ±nÄ± gÃ¶receksiniz!</li>
    </ol>
</div>
{% endblock %}